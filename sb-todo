#!/bin/bash

todo_file="${XDG_DATA_HOME:-$HOME/.local/share}/todo.md"
width=40
state_file="/tmp/dwm_todo_scroll.pos"
log_file="/tmp/dwm_scroll_debug.log"

if [[ ! -f "$todo_file" ]]; then
  echo "No TODO file " && exit 0
fi

# Ignore comment lines starting with # (optional whitespace before #)
text=$(grep -v '^\s*#' "$todo_file" | sed ':a;N;$!ba;s/\n/ ... /g')

length=${#text}

# If text fits within width, print full text and exit (no scroll)
if (( length <= width )); then
  echo -n "$text "
  exit 0
fi

scroll_text="$text    $text"

# Load or init scroll position
if [[ -f "$state_file" ]]; then
  pos=$(<"$state_file")
else
  pos=0
fi

# Handle dwmblocks button input
case $BLOCK_BUTTON in
  1)  pos=0 ;;
  3)  notify-send "$(cat $todo_file)" ;;
  6)  kitty --class floatkitty micro $todo_file ;;
esac

if [[ -z "$BLOCK_BUTTON" ]]; then
  ((pos++))
fi

# Wrap around
(( pos < 0 )) && pos=$((length - 1))
(( pos >= length + 4 )) && pos=0

# Save state
echo "$pos" > "$state_file" || echo "Failed to write" >> "$log_file"

# Output scrolled segment
echo -n "${scroll_text:pos:width} "


