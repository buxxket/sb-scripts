#!/bin/sh

SPEAKER_ID="$(wpctl status | grep speaker | grep -oP '\d+(?=\.)' | head -1)"

show_volume_bar() {
    local vol=$1
    dunstify -u low \
        -h string:x-dunst-stack-tag:volume \
        -h int:value:$vol \
        "Main volume: $vol%"
}

get_vol() {
    volstr="$(wpctl get-volume $SPEAKER_ID)"
    if echo "$volstr" | grep -q '\[MUTED\]'; then
        vol="muted"
    else
        voldec="${volstr#Volume: }"
        vol="$(printf "%.0f" "$(echo "$voldec * 100" | bc)")"
    fi
}

# Get initial volume state
get_vol

# Display appropriate icon
if [ "$vol" = "muted" ]; then
    echo " 󰝟 "
else
    case 1 in
        $((vol >= 70)) ) icon=" 󰕾 " ;;
        $((vol >= 30)) ) icon=" 󰖀 " ;;
        $((vol >= 1)) ) icon=" 󰕿 " ;;
        * ) icon=" 󰝟 " ;;
    esac
    echo "$icon"
fi

# Handle mouse clicks
case $BLOCK_BUTTON in
    1) wpctl set-mute $SPEAKER_ID toggle && get_vol ;;
    3) pwvucontrol ;;
    4) wpctl set-volume $SPEAKER_ID 0.05+ && get_vol && [ "$vol" != "muted" ] && show_volume_bar "$vol" ;;
    5) wpctl set-volume $SPEAKER_ID 0.05- && get_vol && [ "$vol" != "muted" ] && show_volume_bar "$vol" ;;
    6) kitty --class floatkitty micro ~/suckless/dwmblocks/sb-scripts/sb-volume ;;
esac
