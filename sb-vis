#!/bin/sh

CAVA_FIFO="/tmp/cava.fifo"

# Start cava if not running
pgrep -x cava > /dev/null || cava > /dev/null &

# Ensure cava output FIFO exists
[ -p "$CAVA_FIFO" ] || mkfifo "$CAVA_FIFO"

# Read one semicolon-separated line
read -r raw_bars < "$CAVA_FIFO"

# Convert to space-separated
bars=$(echo "$raw_bars" | tr ';' ' ')

# Bar characters
CHARS=(▁ ▂ ▃ ▄ ▅ ▆ ▇ █)
output=""

for n in $bars; do
    idx=$((n * ${#CHARS[@]} / 100))
    [ "$idx" -ge "${#CHARS[@]}" ] && idx=$((${#CHARS[@]} - 1))
    output="${output}${CHARS[$idx]}"
done

echo "$output"
