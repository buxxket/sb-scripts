#!/bin/bash

PIDFILE="$HOME/.mic-tone-keepalive.pid"
PLAY_CMD="play -nq synth sin 1"

case $BLOCK_BUTTON in
    1) wpctl set-mute @DEFAULT_SOURCE@ toggle ;; # Toggle mic mute
    3) pwvucontrol ;;
esac

is_tone_running() {
    [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null
}

start_tone() {
    if ! is_tone_running; then
        $PLAY_CMD >/dev/null 2>&1 &
        echo $! > "$PIDFILE"
    fi
}

stop_tone() {
    if is_tone_running; then
        kill "$(cat "$PIDFILE")" 2>/dev/null
        rm -f "$PIDFILE"
    fi
}

vol="$(timeout 1 wpctl get-volume @DEFAULT_SOURCE@ 2>/dev/null)"

if wpctl status | grep -q "<"; then
    if [ "$vol" != "${vol%\[MUTED\]}" ]; then
        start_tone
        micIcon="󰍭"
    else
        start_tone
        micIcon="󰍬"
    fi
else
    stop_tone
    micIcon=""
fi

if [[ "$(timeout 1 fuser /dev/video* 2>/dev/null)" != '' ]]; then
	vidIcon="󰕧"
else
	vidIcon=""
fi

if [[ -n "$micIcon" && -n "$vidIcon" ]]; then
	echo "[ "$vidIcon" ∣ "$micIcon" ]"
	exit 0
elif [[ -n "$micIcon" || -n "$vidIcon" ]]; then
	echo "[ "$vidIcon""$micIcon" ]"
fi
